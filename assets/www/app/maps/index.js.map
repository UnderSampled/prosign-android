{"version":3,"sources":["index.js"],"names":["onDeviceReady","document","addEventListener","onPause","bind","this","onResume","startTone","hz","context","AudioContext","osc","createOscillator","frequency","value","tone","createGain","gain","connect","destination","start","state","connectToServer","url","ws","WebSocket","onopen","send","onmessage","evt","msg","data","console","log","keyer","box","key","curState","now","performance","length","events","classList","add","remove","navigator","vibrate","push","clearTimeout","timeout","dit","code","setTimeout","codeToTextMap","text","textDisplay","textContent","toSentenceCase","codeDisplay","join","getElementsByClassName","plot","window","requestAnimationFrame","drawPlot","receive","wpm","i","len","t","signal","textToCode","message","m","toUpperCase","textToCodeMap","slice","toLowerCase","ctx","getContext","clearRect","canvas","width","height","lineWidth","strokeStyle","plotState","pos","Math","floor","beginPath","moveTo","lineTo","stroke","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".",","," ","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","Object","keys","Symbol","iterator","next","done","k","err","tx","getElementById","txKey","txKeyer","rx","rxKey","rxKeyer"],"mappings":"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","file":"index.js","sourcesContent":["/* global AudioContext, WebSocket, performance */\r\n\r\n(function () {\r\n  'use strict'\r\n\r\n  var textToCodeMap = {\r\n    'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.',\r\n    'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---',\r\n    'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---',\r\n    'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-',\r\n    'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--',\r\n    'Z': '--..', '.': '.-.-.-', ',': '--..--', ' ': ''\r\n  }\r\n\r\n  var codeToTextMap = {}\r\n  for (let k of Object.keys(textToCodeMap)) {\r\n    codeToTextMap[textToCodeMap[k]] = k\r\n  }\r\n\r\n  document.addEventListener('deviceready', onDeviceReady.bind(this))\r\n  1\r\n  function onDeviceReady () {\r\n    // Handle the Cordova pause and resume events\r\n    document.addEventListener('pause', onPause.bind(this))\r\n    document.addEventListener('resume', onResume.bind(this))\r\n\r\n    // TODO: Cordova has been loaded. Perform any initialization that requires Cordova here.\r\n  }\r\n\r\n  function onPause () {\r\n    // TODO: This application has been suspended. Save application state here.\r\n  }\r\n\r\n  function onResume () {\r\n    // TODO: This application has been reactivated. Restore application state here.\r\n  }\r\n\r\n  var tx = document.getElementById('tx')\r\n  var txKey = keyer(tx)\r\n  var txKeyer = tx.getElementsByClassName('keyer')[0]\r\n  txKeyer.addEventListener('touchstart', function () { txKey(true) })\r\n  txKeyer.addEventListener('touchend', function () { txKey(false) })\r\n\r\n  var rx = document.getElementById('rx')\r\n  var rxKey = keyer(rx)\r\n  var rxKeyer = rx.getElementsByClassName('keyer')[0]\r\n  rxKeyer.addEventListener('touchend', function () { receive(rxKey, textToCode('This is a test.'), 18) })\r\n\r\n  connectToServer('ws://localhost:8080/morse')\r\n\r\n  function startTone (hz) {\r\n    var context = new AudioContext() // one context per document\r\n    var osc = context.createOscillator() // instantiate an oscillator\r\n    osc.frequency.value = hz\r\n    var tone = context.createGain()\r\n    tone.gain.value = 0 // from 0 to 1, 1 full volume, 0 is muted\r\n    osc.connect(tone) // connect osc to vol\r\n    tone.connect(context.destination) // connect it to the destination\r\n    osc.start()\r\n\r\n    return function setTone (state) {\r\n      tone.gain.value = (state ? 1 : 0)\r\n    }\r\n  }\r\n\r\n  function connectToServer (url) {\r\n    var ws = new WebSocket(url)\r\n    ws.onopen = function () {\r\n      ws.send('KM4DVF')\r\n    }\r\n    ws.onmessage = function (evt) {\r\n      var msg = evt.data\r\n      console.log(msg)\r\n    }\r\n\r\n    return function send (msg) {\r\n      ws.send(msg)\r\n    }\r\n  }\r\n\r\n  function keyer (box) {\r\n    var keyer = box.getElementsByClassName('keyer')[0]\r\n    var plot = box.getElementsByClassName('plot')[0]\r\n    var codeDisplay = box.getElementsByClassName('code')[0]\r\n    var textDisplay = box.getElementsByClassName('text')[0]\r\n\r\n    var tone = startTone(750)\r\n\r\n    var events = [[performance.now(), false]]\r\n    var code = ['']\r\n    var text = ''\r\n\r\n    var curState = false\r\n    var timeout\r\n\r\n    var dit = 1200 / 19\r\n\r\n    function key (state) {\r\n      if (state !== curState) {\r\n        curState = state\r\n        var now = performance.now()\r\n\r\n        var length = now - events[events.length - 1][0]\r\n\r\n        if (state) keyer.classList.add('hot')\r\n        else keyer.classList.remove('hot')\r\n\r\n        navigator.vibrate(state ? 10000 : 0)\r\n        tone(state)\r\n        events.push([now, state])\r\n\r\n        if (!state) {\r\n          if (length >= 3 * dit) code[code.length - 1] += '-'\r\n          else code[code.length - 1] += '.'\r\n\r\n          timeout = setTimeout(function () {\r\n            if (codeToTextMap[code[code.length - 1]]) {\r\n              text += codeToTextMap[code[code.length - 1]]\r\n              textDisplay.textContent = toSentenceCase(text)\r\n            }\r\n\r\n            code.push('')\r\n\r\n            timeout = setTimeout(function () {\r\n              text += ' '\r\n              code.push('')\r\n\r\n              timeout = setTimeout(function () {\r\n                code = ['']\r\n                text = ''\r\n\r\n                codeDisplay.textContent = ' '\r\n                textDisplay.textContent = ' '\r\n              }, 3000)\r\n            }, 4 * dit)\r\n          }, 3 * dit)\r\n\r\n          codeDisplay.textContent = code.join(' ')\r\n        }\r\n        else clearTimeout(timeout)\r\n      }\r\n    }\r\n\r\n    window.requestAnimationFrame(function (now) { drawPlot(now, plot, events) })\r\n\r\n    return key\r\n  }\r\n\r\n  function receive (key, code, wpm) {\r\n    var t = 0\r\n    var signal = []\r\n    var dit = 1200 / wpm\r\n\r\n    var i, len\r\n    for (i = 0, len = code.length; i < len; i++) {\r\n      switch (code[i]) {\r\n        case '.':\r\n          signal.push(t)\r\n          t += dit\r\n          signal.push(t)\r\n          break\r\n        case '-':\r\n          signal.push(t)\r\n          t += 3 * dit\r\n          signal.push(t)\r\n          break\r\n        case ' ':\r\n          t += dit\r\n          if (code[i - 1] === ' ') t += 5 * dit\r\n          break\r\n      }\r\n      t += dit\r\n    }\r\n\r\n    var state = false\r\n    for (i = 0, len = signal.length; i < len; i++) {\r\n      state = !state\r\n      setTimeout(function (state) { key(state) }, signal[i], state)\r\n    }\r\n  }\r\n\r\n  function textToCode (message) {\r\n    var code = []\r\n    var m = message.toUpperCase()\r\n    for (var i = 0, len = message.length; i < len; i++) code.push(textToCodeMap[m[i]])\r\n    return code.join(' ')\r\n  }\r\n\r\n  /*\r\n  function codeToText (message) {\r\n    var text = ''\r\n    var m = message.split(' ')\r\n    for (var i = 0, len = m.length; i < len; i++) text += codeToTextMap[m[i]]\r\n    return toSentenceCase(text)\r\n  }\r\n  */\r\n\r\n  function toSentenceCase (text) {\r\n    return text[0] + text.slice(1).toLowerCase()\r\n  }\r\n\r\n  function drawPlot (now, plot, events) {\r\n    var ctx = plot.getContext('2d')\r\n    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)\r\n\r\n    ctx.lineWidth = ctx.canvas.height\r\n    ctx.strokeStyle = '#555'\r\n\r\n    var plotState = false\r\n    for (var i = 0, len = events.length; i < len; i++) {\r\n      var pos = Math.floor(ctx.canvas.width - (now - events[i][0]) / 10)\r\n\r\n      if (plotState !== events[i][1]) {\r\n        plotState = events[i][1]\r\n        if (plotState) {\r\n          ctx.beginPath()\r\n          ctx.moveTo(pos, ctx.lineWidth / 2)\r\n        } else {\r\n          ctx.lineTo(pos, ctx.lineWidth / 2)\r\n          ctx.stroke()\r\n        }\r\n      }\r\n    }\r\n    if (events[events.length - 1][1]) {\r\n      ctx.lineTo(ctx.canvas.width, ctx.lineWidth / 2)\r\n      ctx.stroke()\r\n    }\r\n\r\n    window.requestAnimationFrame(function (now) { drawPlot(now, plot, events) })\r\n  }\r\n})()\r\n"],"sourceRoot":"/source/"}